// server/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SubscriptionType {
  FREE
  MONTHLY
  ANNUAL
  LIFETIME
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      String   @default("STUDENT")
  tier      String   @default("FREE")
  avatar    String?
  createdAt DateTime @default(now())

  // Subscription details
  subscriptionType   SubscriptionType @default(FREE)
  subscriptionExpiry DateTime? // Expiry date for annual subscriptions
  paddleCustomerId   String? // For future payment integration

  // Email verification
  isVerified              Boolean   @default(false)
  verificationToken       String?   @unique
  verificationTokenExpiry DateTime?

  // Password reset
  resetToken       String?   @unique
  resetTokenExpiry DateTime?

  // OAuth providers
  googleId String? @unique // Google account ID for OAuth users

  // Learning progress tracking
  lastInstitute String? // Last selected institute
  lastLevel     Int? // Last selected level
  lastUnit      Int? // Last selected unit
  lastModule    String? // Last active module (VOCAB, READING, LISTENING, GRAMMAR)

  savedWords         SavedWord[]
  mistakes           Mistake[]
  annotations        Annotation[]
  examHistory        ExamAttempt[]
  learningActivities LearningActivity[]
  notebookEntries    NotebookEntry[]

  // Podcast relations
  subscribedChannels PodcastChannel[]
  likedEpisodes      PodcastEpisode[]
  listeningHistory   ListeningHistory[]
}

model ListeningHistory {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id])
  episodeGuid  String
  episodeTitle String
  episodeUrl   String
  channelName  String
  channelImage String?
  progress     Int      @default(0) // Playback progress in seconds
  playedAt     DateTime @default(now())

  @@unique([userId, episodeGuid])
  @@index([userId])
}

model Institute {
  id           String  @id
  name         String
  levels       String
  coverUrl     String? // Cover image URL for textbooks
  themeColor   String? // Theme color in hex format (e.g. #1e3a8a)
  publisher    String? // University/Publisher name for filtering
  displayLevel String? // Display level like "一级", "1급"
  volume       String? // Volume like "上册", "下册"
  totalUnits   Int? // Total number of units in this textbook

  // Relations for global search
  vocabAppearances   VocabularyAppearance[]
  grammarAppearances CourseGrammar[]
  units              TextbookUnit[] // New: relational reading content
}

model TextbookContent {
  key               String  @id
  contentUrl        String? // S3 URL pointing to full content JSON
  readingTitle      String?
  listeningTitle    String?
  listeningAudioUrl String?
  isPaid            Boolean @default(false)

  // ========== DEPRECATED: Legacy JSON fields ==========
  // These fields are being phased out in favor of:
  // - VocabularyAppearance + Word tables for vocabulary
  // - TextbookUnit for reading content
  // - CourseGrammar + GrammarPoint tables for grammar
  generalContext       String? // @deprecated
  vocabularyList       String? // @deprecated - Use VocabularyAppearance
  readingText          String? // @deprecated - Use TextbookUnit
  readingTranslation   String? // @deprecated - Use TextbookUnit
  listeningScript      String? // @deprecated
  listeningTranslation String? // @deprecated
  grammarList          String? // @deprecated - Use CourseGrammar
}

// ========== Reading Content ==========
model TextbookUnit {
  id String @id @default(uuid())

  courseId  String // Foreign key to Institute
  course    Institute @relation(fields: [courseId], references: [id])
  unitIndex Int // Unit number (1, 2, 3...)

  title       String // Lesson title (e.g., "자기 소개")
  readingText String  @db.Text // Full reading content (long text)
  translation String? @db.Text // Chinese translation (optional)
  
  // AI Analysis Data: Morphological analysis results
  // Structure: [{ surface: "갔습니다", base: "가다", offset: 0, length: 4, pos: "Verb" }]
  analysisData Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([courseId, unitIndex]) // Each unit appears once per course
  @@index([courseId])
}

// ========== Listening Content (Completely Separate) ==========
model ListeningUnit {
  id String @id @default(uuid())

  courseId  String // Foreign key to Institute (no relation to avoid circular ref)
  unitIndex Int // Unit number (1, 2, 3...)

  title    String // Listening lesson title
  audioUrl String // S3 URL for audio file
  
  // Timestamped transcript for karaoke-style playback
  // Structure: [{ start: 0, end: 2.5, text: "안녕하세요", translation: "你好" }]
  transcriptData Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([courseId, unitIndex]) // Each listening unit appears once per course
  @@index([courseId])
}

model TopikExam {
  id          String   @id
  title       String
  round       Int
  type        String
  paperType   String?
  timeLimit   Int
  audioUrl    String?
  description String?  @db.Text
  questions   Json
  createdAt   DateTime @default(now())
  isPaid      Boolean  @default(false) // Whether this exam requires paid subscription
}

model SavedWord {
  id                 String   @id @default(uuid())
  userId             String
  user               User     @relation(fields: [userId], references: [id])
  korean             String
  english            String
  pos                String?
  exampleSentence    String?
  exampleTranslation String?
  unit               Int?
  createdAt          DateTime @default(now())
}

model Mistake {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  korean    String
  english   String
  createdAt DateTime @default(now())
}

model Annotation {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  // 文本标注字段（教材模块使用）
  contextKey    String
  startOffset   Int?
  endOffset     Int?
  sentenceIndex Int?
  text          String
  color         String?
  note          String?

  // TOPIK 画板字段（新增）
  targetType String  @default("TEXTBOOK") // "TEXTBOOK" 或 "EXAM"
  targetId   String? // ExamID（可选）
  pageIndex  Int? // 题号/页码（可选）
  data       Json? // Canvas 矢量线条数据（可选）
  visibility String  @default("PRIVATE") // PRIVATE, PUBLIC, CLASS

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@index([userId, targetType, targetId, pageIndex])
}

model ExamAttempt {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  examId      String
  examTitle   String
  score       Int
  maxScore    Int
  userAnswers Json
  timestamp   DateTime @default(now())
}

model LearningActivity {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id])
  activityType String // 'VOCAB', 'READING', 'LISTENING', 'GRAMMAR', 'EXAM'
  duration     Int? // Duration in minutes
  itemsStudied Int? // Number of words/questions/passages studied
  metadata     Json? // JSON for additional data
  createdAt    DateTime @default(now())
  date         DateTime @default(now()) // Date part for daily tracking

  @@index([userId, date])
}

model LegalDocument {
  id        String   @id // 'terms', 'privacy', 'refund'
  title     String
  content   String   @db.Text
  updatedAt DateTime @default(now())
  updatedBy String? // Admin user ID who updated it
}

model DailyPhrase {
  id           String   @id @default(uuid())
  korean       String // 韩文句子，例如：좋은 하루 되세요!
  romanization String // 发音，例如：Jo-eun ha-ru doe-se-yo!
  chinese      String // 中文翻译
  english      String? // 英文翻译（可选）
  dayIndex     Int      @unique // 第几天（1-365，循环使用）
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// Canvas 笔迹/板书数据
model CanvasAnnotation {
  id         String   @id @default(uuid())
  userId     String
  targetType String // "TEXTBOOK" 或 "EXAM"
  targetId   String // 对应的内容ID
  pageIndex  Int // 第几页
  data       Json // 存储 Canvas 笔迹数据
  visibility String   @default("PRIVATE") // PRIVATE, PUBLIC, CLASS
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId])
  @@index([targetType, targetId])
  @@index([userId, targetType, targetId])
}

// 用户学习进度
model UserProgress {
  id          String   @id @default(uuid())
  userId      String
  contentType String // 内容类型
  contentId   String // 内容ID
  progress    Int      @default(0) // 进度百分比
  completed   Boolean  @default(false)
  isHomework  Boolean  @default(false) // 是否为作业
  assignedBy  String? // 布置作业的老师ID（可选）
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, contentType, contentId])
  @@index([userId])
  @@index([assignedBy])
}

// 智能笔记本 - 内容存储在 S3，仅元数据在数据库
model NotebookEntry {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type  String // "VOCAB", "GRAMMAR", "MISTAKE"
  title String // e.g., "가시다"

  // S3 Key path (e.g., "notebook/user_123/uuid.json")
  storageKey String

  // Lightweight preview for List View (avoids fetching S3)
  preview String?

  tags String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, type])
}

// YouTube Immersive Learning Models

model Video {
  id           String       @id @default(uuid())
  youtubeId    String       @unique
  title        String
  thumbnail    String?
  channelTitle String?
  duration     Int? // Duration in seconds
  transcripts  Transcript[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Transcript {
  id      String @id @default(uuid())
  videoId String
  video   Video  @relation(fields: [videoId], references: [id], onDelete: Cascade)

  language      String // e.g., "ko", "zh-CN", "en"
  isAIProcessed Boolean @default(false) // True if processed by Gemini with grammar analysis

  // S3 Key path for the full JSON content (e.g., "transcripts/abc123_ai.json")
  storageKey String

  createdAt DateTime @default(now())

  // Ensure we don't have duplicate transcript types for the same video
  @@unique([videoId, language, isAIProcessed])
  @@index([videoId])
}

// ============================================
// Podcast Learning Models
// ============================================

model PodcastChannel {
  id          String  @id @default(uuid())
  itunesId    String  @unique // iTunes collectionId for syncing
  title       String
  author      String
  feedUrl     String
  artworkUrl  String?
  description String? @db.Text
  isFeatured  Boolean @default(false) // Admin control for Editor's Picks

  subscribers User[]
  episodes    PodcastEpisode[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isFeatured])
}

model PodcastEpisode {
  id          String    @id @default(uuid())
  guid        String    @unique // Unique identifier from RSS (usually URL or ID)
  title       String
  audioUrl    String
  duration    Int? // Duration in seconds
  pubDate     DateTime?
  description String?   @db.Text

  views Int @default(0)
  likes Int @default(0)

  channelId String
  channel   PodcastChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  likedBy User[]

  createdAt DateTime @default(now())

  @@index([channelId])
  @@index([pubDate])
}

// ========== Vocabulary SRS System ==========

enum PartOfSpeech {
  NOUN
  VERB_T // 他动词 (Transitive)
  VERB_I // 自动词 (Intransitive)
  ADJ // 形容词
  ADV // 副词
  PARTICLE // 助词
}

enum WordStatus {
  NEW
  LEARNING
  REVIEW
  MASTERED
}

// ========== Vocabulary System (Refactored) ==========
// Word is a master dictionary table - each unique word exists once
// VocabularyAppearance links words to courses/units (many-to-many)

model Word {
  id String @id @default(cuid())

  // Core Data (unique per word)
  word         String @unique // e.g., "학교" - globally unique
  meaning      String // e.g., "学校"
  partOfSpeech String // "NOUN", "VERB_T", "VERB_I", "ADJ", "ADV", "PARTICLE"

  // Rich Data
  hanja         String? // e.g., "學校"
  pronunciation String? // e.g., "hak-gyo"
  audioUrl      String? // S3 URL, NULL = no audio button

  // Structured Tips (synonyms, antonyms, nuance)
  tips Json? // { synonyms: [], antonyms: [], nuance: "" }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  appearances VocabularyAppearance[]
  progress    UserWordProgress[]

  @@index([audioUrl]) // For "Missing Audio" filter
}

model VocabularyAppearance {
  id String @id @default(cuid())

  wordId String
  word   Word   @relation(fields: [wordId], references: [id], onDelete: Cascade)

  courseId String // Links to Institute.id (textbook)
  course   Institute @relation(fields: [courseId], references: [id])
  unitId   Int // 1, 2, 3... for sorting within course

  // Unit-specific examples (same word can have different examples per course)
  exampleSentence String? // Korean sentence
  exampleMeaning  String? // Chinese translation

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([wordId, courseId, unitId]) // Same word can appear once per unit per course
  @@index([courseId, unitId])
  @@index([courseId])
}

model UserWordProgress {
  id     String @id @default(cuid())
  userId String
  wordId String
  word   Word   @relation(fields: [wordId], references: [id], onDelete: Cascade)

  // SRS Fields
  status       WordStatus @default(NEW)
  nextReviewAt DateTime? // UTC time for scheduling
  interval     Int        @default(0) // Days between reviews
  easeFactor   Float      @default(2.5) // Difficulty multiplier (min 1.3)
  streak       Int        @default(0) // Consecutive correct answers

  // Meta
  lastReviewedAt DateTime?
  mistakeCount   Int       @default(0)

  @@unique([userId, wordId])
}

// ========== Grammar Training System (Global Knowledge Graph) ==========

// 1. Global Master Grammar Library (Source of Truth)
model GrammarPoint {
  id        String  @id @default(uuid())
  title     String  @unique // e.g., "-고 싶다" (Unique Identifier)
  slug      String? // e.g., "go-sip-da"
  searchKey String? @unique // e.g., "고싶다" - for fuzzy search (no symbols/spaces)

  level   String // "TOPIK 1", "TOPIK 2"
  type    String // "ENDING", "PARTICLE", "CONNECTIVE"
  summary String // e.g., "表示愿望，想做..."

  explanation      String // Markdown content
  conjugationRules Json // e.g., { "verb": { "hasBatchim": "...", "noBatchim": "..." } }
  examples         Json // Array of { kr, cn, audio? }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  courseRefs   CourseGrammar[]
  userProgress UserGrammarProgress[]
}

// 2. Course-Grammar Relation (The Connector)
model CourseGrammar {
  id       String    @id @default(uuid())
  courseId String // Foreign Key to Course/Textbook (Institute.id)
  course   Institute @relation(fields: [courseId], references: [id])
  unitId   Int // e.g., 1 (Unit 1)

  grammarId String
  grammar   GrammarPoint @relation(fields: [grammarId], references: [id])

  displayOrder Int // Order within the unit (1, 2, 3)
  customNote   String? // Optional override/note for this specific course

  @@unique([courseId, unitId, grammarId]) // Prevent duplicates in same unit
  @@index([courseId, unitId])
}

// 3. User Progress (Bound to Master Grammar)
model UserGrammarProgress {
  id     String @id @default(uuid())
  userId String

  grammarPointId String
  grammar        GrammarPoint @relation(fields: [grammarPointId], references: [id])

  status      String @default("NEW") // NEW, LEARNING, MASTERED
  proficiency Int    @default(0) // 0-100

  lastReviewed   DateTime?
  mistakeHistory Json? // Array of error logs

  @@unique([userId, grammarPointId])
  @@index([userId])
}

// 4. AI Usage Logging (For cost monitoring)
model AiUsageLog {
  id           String   @id @default(uuid())
  feature      String   // e.g., "TEXT_ANALYSIS", "GRAMMAR_CHECK", "TTS"
  model        String   // e.g., "gpt-4o-mini"
  inputTokens  Int
  outputTokens Int
  cost         Float    // Estimated cost in USD
  userId       String?  // User who triggered the operation (optional)
  createdAt    DateTime @default(now())

  @@index([createdAt])
  @@index([feature])
}
